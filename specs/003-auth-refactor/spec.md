# Feature Specification: 后端登录鉴权系统重构

**Feature Branch**: `003-auth-refactor`
**Created**: 2026-01-17
**Status**: Draft
**Input**: User description: "目前后端登录鉴权有大问题，建议重构"

## 问题背景

当前系统的认证机制存在以下问题：
- Session cookie在登录后未能正确传递到后续请求
- 用户登录成功后立即收到401未授权错误
- Cookie设置和传递机制不可靠
- 缺少清晰的认证状态管理

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用户成功登录并访问受保护资源 (Priority: P1)

作为系统用户，我希望输入正确的邮箱和密码后能够成功登录，并且后续请求能够自动携带认证信息，无需重复登录。

**Why this priority**: 这是最核心的功能，所有用户必须能够登录才能使用系统。如果登录后无法访问任何功能，系统完全不可用。

**Independent Test**: 可以通过以下步骤独立测试：用户在登录页面输入凭据 → 提交登录请求 → 登录成功后自动跳转到首页 → 首页能够正确显示用户信息（调用/auth/me成功） → 用户可以访问其他受保护的页面而不会被踢回登录页。

**Acceptance Scenarios**:

1. **Given** 用户在登录页面，**When** 输入正确的邮箱和密码并点击登录，**Then** 系统返回登录成功响应，设置认证凭据，并跳转到首页
2. **Given** 用户已成功登录，**When** 访问需要认证的页面（如/dashboard、/profile），**Then** 页面正常加载，不会跳转回登录页
3. **Given** 用户已成功登录，**When** 刷新浏览器页面，**Then** 用户仍然保持登录状态，无需重新登录
4. **Given** 用户已成功登录，**When** 打开新的浏览器标签页访问系统，**Then** 新标签页中用户也是登录状态
5. **Given** 用户勾选"记住我"并登录成功，**When** 关闭浏览器后重新打开，**Then** 用户仍然保持登录状态（30天内）

---

### User Story 2 - 用户登录失败并收到清晰提示 (Priority: P1)

作为系统用户，当我输入错误的登录凭据时，我希望收到明确的错误提示，告诉我哪里出错了（例如密码错误、账号不存在等），而不是模糊的错误信息。

**Why this priority**: 用户体验的基础，用户必须知道为什么登录失败才能采取正确的行动（重试、重置密码等）。

**Independent Test**: 可以通过以下步骤独立测试：使用不存在的邮箱登录 → 看到"账号不存在"错误 → 使用存在的邮箱但错误的密码登录 → 看到"密码错误"提示 → 尝试次数过多后看到"账号已锁定"提示。

**Acceptance Scenarios**:

1. **Given** 用户在登录页面，**When** 输入不存在的邮箱，**Then** 系统返回"邮箱或密码错误"（安全起见，不明确指出邮箱不存在）
2. **Given** 用户在登录页面，**When** 输入正确的邮箱但密码错误，**Then** 系统返回"邮箱或密码错误"
3. **Given** 用户连续5次登录失败，**When** 尝试第6次登录，**Then** 系统返回"尝试次数过多，请10分钟后再试"
4. **Given** 用户账号已被管理员禁用，**When** 尝试登录，**Then** 系统返回"账号已被禁用，请联系管理员"

---

### User Story 3 - 用户安全退出登录 (Priority: P1)

作为系统用户，我希望点击退出按钮后能够清除所有认证信息，确保其他人无法访问我的账号。

**Why this priority**: 安全性的基本要求，用户必须能够安全地结束会话，特别是在共享设备上使用时。

**Independent Test**: 可以通过以下步骤独立测试：用户登录 → 访问受保护页面确认可访问 → 点击退出按钮 → 退出后尝试访问受保护页面 → 被重定向到登录页 → 浏览器的认证凭据已被清除。

**Acceptance Scenarios**:

1. **Given** 用户已登录，**When** 点击退出按钮，**Then** 系统清除所有认证信息并跳转到登录页
2. **Given** 用户已退出登录，**When** 尝试访问受保护页面，**Then** 被重定向到登录页
3. **Given** 用户已退出登录，**When** 点击浏览器的后退按钮，**Then** 不会看到之前的受保护页面内容，而是被重定向到登录页
4. **Given** 用户在多个标签页中登录，**When** 在其中一个标签页退出登录，**Then** 其他标签页的用户也应该退出（会话失效）

---

### User Story 4 - 会话自动过期保护 (Priority: P2)

作为系统管理员，我希望用户的会话在一段时间不活动后自动过期，以防止未授权访问。

**Why this priority**: 重要的安全特性，但不影响核心登录流程。可以在P1功能稳定后添加。

**Independent Test**: 可以通过以下步骤独立测试：用户登录 → 设置会话过期时间为2分钟 → 等待2分钟不操作 → 尝试访问受保护页面 → 被重定向到登录页并提示"会话已过期，请重新登录"。

**Acceptance Scenarios**:

1. **Given** 用户已登录但30分钟内无任何操作，**When** 尝试访问受保护页面，**Then** 系统提示"会话已过期"并跳转到登录页
2. **Given** 用户已登录且在活动中（每5分钟有一次请求），**When** 经过2小时，**Then** 用户仍然保持登录状态（会话自动续期）
3. **Given** 用户勾选了"记住我"，**When** 30天内首次访问系统，**Then** 用户仍然保持登录状态

---

### User Story 5 - 跨设备登录管理 (Priority: P3)

作为系统用户，我希望能够查看当前在哪些设备上登录，并能够远程注销其他设备的会话。

**Why this priority**: 提升用户安全感的增强功能，但不影响基本的登录使用。

**Independent Test**: 可以通过以下步骤独立测试：用户在设备A登录 → 在设备B也登录 → 在设备A查看活动会话列表 → 看到2个会话（设备A和设备B）→ 在设备A上注销设备B的会话 → 设备B自动退出登录。

**Acceptance Scenarios**:

1. **Given** 用户已在多个设备登录，**When** 访问"账号安全"页面，**Then** 看到所有活动会话列表（设备类型、IP地址、登录时间）
2. **Given** 用户查看活动会话列表，**When** 点击某个会话的"注销"按钮，**Then** 该设备的会话立即失效
3. **Given** 用户点击"注销所有其他设备"，**When** 确认操作，**Then** 除当前设备外的所有会话都被注销

---

### Edge Cases

- 用户在登录过程中网络中断，部分请求失败
- 用户同时在多个标签页尝试登录（竞态条件）
- 用户的认证cookie被手动篡改或删除
- 用户在会话即将过期时发起请求（会话续期的时机）
- 用户快速连续点击登录按钮（防止重复提交）
- 系统时钟不同步导致的会话过期判断错误
- Redis存储层故障，会话数据无法读取
- Cookie因浏览器隐私设置被阻止（SameSite策略）
- 用户从HTTP切换到HTTPS或反之（Cookie安全策略）
- 用户登录后立即删除浏览器cookie（手动清除）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持邮箱和密码的用户认证方式
- **FR-002**: 系统必须在用户登录成功后设置安全的认证凭据（HttpOnly cookie）
- **FR-003**: 系统必须在所有需要认证的API请求中验证用户身份
- **FR-004**: 系统必须在认证失败时返回401状态码，并提供清晰的错误信息
- **FR-005**: 系统必须支持"记住我"功能，允许用户选择延长会话有效期（30天）
- **FR-006**: 系统必须在用户退出登录时清除所有认证信息
- **FR-007**: 系统必须在会话过期后要求用户重新登录
- **FR-008**: 系统必须对失败的登录尝试进行速率限制（5次失败后锁定10分钟）
- **FR-009**: 系统必须记录所有登录、退出和认证失败事件（审计日志）
- **FR-010**: 系统必须支持跨标签页的会话同步（一个标签页退出，其他标签页也失效）
- **FR-011**: 系统必须在会话活动时自动续期（每次请求延长过期时间）
- **FR-012**: 系统必须处理OPTIONS预检请求，不对其进行认证检查
- **FR-013**: 系统必须正确设置CORS头，允许跨域携带cookie（credentials: include）
- **FR-014**: 系统必须验证cookie的domain、path、secure、SameSite等属性配置正确
- **FR-015**: 系统必须在认证失败时清除可能存在的无效cookie

### Key Entities

- **User（用户）**: 系统中需要认证的实体，包含邮箱、密码哈希、是否激活、最后登录时间等属性
- **Session（会话）**: 用户登录后的认证状态，包含用户ID、创建时间、过期时间、IP地址、User-Agent等属性
- **AuthenticationAttempt（认证尝试）**: 登录尝试记录，包含邮箱、IP地址、是否成功、失败原因、时间戳等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在3秒内完成登录流程（从提交凭据到进入首页）
- **SC-002**: 登录成功后，用户访问任何受保护页面都不会收到401错误（100%成功率）
- **SC-003**: 用户刷新页面或打开新标签页后仍然保持登录状态（会话持久性：99.9%）
- **SC-004**: 用户退出登录后，所有认证信息被清除，无法访问受保护资源（安全性：100%）
- **SC-005**: 系统能够处理1000个并发登录请求而不出现认证错误
- **SC-006**: 会话过期后，用户尝试访问受保护资源时能够收到明确的"会话已过期"提示（100%准确率）
- **SC-007**: 认证相关的错误日志能够清晰定位问题原因（日志完整性：100%）
- **SC-008**: 用户在使用"记住我"功能后，30天内无需重新登录（长会话可靠性：99%）

## Assumptions *(mandatory)*

- 用户使用现代浏览器（支持HttpOnly cookie、SameSite属性）
- 前端和后端在同一域名下或配置了正确的CORS策略
- Redis作为会话存储层，保证高可用性（99.9%）
- 用户设备的系统时钟基本准确（误差小于5分钟）
- 默认会话过期时间为30分钟（无操作时），"记住我"会话为30天
- 登录失败锁定时间为10分钟，失败次数阈值为5次
- 认证使用bcrypt密码哈希（成本因子12）
- Cookie使用HttpOnly、SameSite=Lax（开发环境Secure=false，生产环境Secure=true）

## Out of Scope

- OAuth2/OIDC第三方登录集成（已有独立的SSO模块）
- 双因素认证（2FA/MFA）
- 密码重置和邮箱验证流程（已在002-auth-integration中实现）
- 用户注册功能（已在002-auth-integration中实现）
- 基于角色的访问控制（RBAC）细节（仅需验证用户已认证）
- API密钥认证（用于服务间调用）
- 前端UI/UX改进（仅关注后端认证机制）

## Dependencies

- 现有的User模型和数据库表结构
- Redis服务（用于会话存储）
- 现有的002-auth-integration实现（注册、密码重置等功能）
- 前端AuthContext和API客户端实现

## Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Cookie在某些浏览器中被阻止（隐私设置） | High | 提供清晰的错误提示，引导用户调整浏览器设置；考虑在开发环境中使用宽松的SameSite策略 |
| Redis故障导致所有会话丢失 | High | 实现Redis集群或主从复制；提供降级方案（临时使用数据库存储） |
| 会话续期逻辑导致性能问题 | Medium | 使用条件续期（仅在会话过期时间少于一半时续期）；优化Redis连接池 |
| 跨域场景下cookie无法传递 | Medium | 严格验证CORS配置；在文档中明确说明跨域限制 |
| 时钟不同步导致会话过期判断错误 | Low | 使用相对时间而非绝对时间判断过期；在服务器端统一时间源 |
