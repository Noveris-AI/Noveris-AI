# Feature Specification: 前后端鉴权集成与登录流程优化

**Feature Branch**: `002-auth-integration`
**Created**: 2026-01-16
**Status**: Draft
**Input**: User description: "目前后端有一套鉴权机制,前端目前完全是mock的鉴权,我需要你全面检查后端鉴权的合理性,并且前端用真实的鉴权,并且前端不再自动进入主页,而是从登录页正常开始"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 正常登录流程 (Priority: P1)

用户打开应用时,系统展示登录页面,用户输入邮箱和密码后成功登录,进入系统主页。

**Why this priority**: 这是最基础的用户认证流程,是所有后续功能的前提,必须首先实现。

**Independent Test**: 可以通过访问应用根路径,验证是否正确显示登录页,并通过测试账号完成完整的登录流程,成功进入主页,即可验证此功能独立工作。

**Acceptance Scenarios**:

1. **Given** 用户未登录, **When** 访问应用根路径 (/) 或任何受保护页面, **Then** 自动重定向到登录页面 (/auth/login)
2. **Given** 用户在登录页, **When** 输入有效的邮箱和密码并点击登录, **Then** 系统验证凭据,创建会话,返回用户信息,并重定向到主页 (/dashboard/homepage)
3. **Given** 用户在登录页, **When** 输入错误的邮箱或密码, **Then** 显示错误提示"邮箱或密码错误",不创建会话,停留在登录页
4. **Given** 用户已登录, **When** 直接访问登录页, **Then** 自动跳转到主页
5. **Given** 用户登录时勾选"记住我", **When** 登录成功后关闭浏览器重新打开, **Then** 用户仍然保持登录状态

---

### User Story 2 - 会话管理和登出 (Priority: P2)

用户登录后,系统维护会话状态。用户可以主动登出,或会话过期时自动退出登录。

**Why this priority**: 会话管理是用户认证的核心组成部分,确保安全性和用户体验,需要在基本登录流程后立即实现。

**Independent Test**: 登录系统后,点击登出按钮验证能否正确清除会话并返回登录页;或等待会话超时后刷新页面,验证是否重定向到登录页。

**Acceptance Scenarios**:

1. **Given** 用户已登录, **When** 点击登出按钮, **Then** 系统销毁会话,清除Cookie,返回登录页
2. **Given** 用户已登录, **When** 会话超时后访问任何受保护页面, **Then** 系统返回401错误,前端清除本地状态并重定向到登录页
3. **Given** 用户已登录, **When** 在请求过程中收到401响应, **Then** 前端自动清除认证状态并重定向到登录页
4. **Given** 用户在多个标签页登录, **When** 在其中一个标签页登出, **Then** 其他标签页下次请求时也会检测到会话失效并重定向到登录页

---

### User Story 3 - API请求鉴权 (Priority: P1)

前端所有API请求自动携带会话凭证,后端验证会话有效性后处理请求。

**Why this priority**: 这是真实鉴权的核心,必须与登录流程同时实现,否则用户登录后无法访问任何功能。

**Independent Test**: 登录后访问任何需要鉴权的API端点(如节点列表),验证请求成功;未登录时访问,验证返回401错误。

**Acceptance Scenarios**:

1. **Given** 用户已登录, **When** 前端发起任何API请求, **Then** 请求自动携带会话Cookie,后端验证通过后返回数据
2. **Given** 用户未登录, **When** 前端发起受保护的API请求, **Then** 后端返回401错误,前端重定向到登录页
3. **Given** 用户会话已过期, **When** 前端发起API请求, **Then** 后端返回401错误,前端清除状态并重定向到登录页
4. **Given** 用户已登录, **When** API请求失败并返回401, **Then** 前端全局拦截器捕获此错误,自动重定向到登录页

---

### User Story 4 - 用户注册流程 (Priority: P3)

新用户通过注册页面创建账号,接收验证码,完成注册后可以登录。

**Why this priority**: 注册流程是用户获取账号的途径,但已有账号的用户可以先通过登录使用系统,因此优先级较低。

**Independent Test**: 访问注册页面,输入邮箱获取验证码,填写完整信息后成功创建账号,然后使用该账号登录系统。

**Acceptance Scenarios**:

1. **Given** 用户在注册页, **When** 输入邮箱并请求验证码, **Then** 系统发送验证码到邮箱,显示"验证码已发送"提示
2. **Given** 用户在注册页, **When** 输入有效的邮箱、验证码、密码和姓名并提交, **Then** 系统创建用户账号,显示成功提示,并引导用户到登录页
3. **Given** 用户在注册页, **When** 输入已存在的邮箱, **Then** 系统返回"该邮箱已注册"错误,不创建账号
4. **Given** 用户在注册页, **When** 输入不符合要求的密码(长度不足、缺少大写字母等), **Then** 显示密码强度要求提示,不允许提交

---

### User Story 5 - 密码重置流程 (Priority: P3)

用户忘记密码时,可以通过邮箱接收重置链接或验证码,设置新密码。

**Why this priority**: 密码重置是辅助功能,对已有账号的用户有帮助,但不是核心登录流程,可以延后实现。

**Independent Test**: 在登录页点击"忘记密码",输入注册邮箱,接收重置链接或验证码,设置新密码后使用新密码登录。

**Acceptance Scenarios**:

1. **Given** 用户在忘记密码页, **When** 输入注册邮箱并提交, **Then** 系统发送密码重置链接/验证码到邮箱,显示"重置链接已发送"提示
2. **Given** 用户收到重置链接, **When** 点击链接并输入新密码, **Then** 系统验证令牌,更新密码,显示成功提示,并引导用户到登录页
3. **Given** 用户使用验证码模式, **When** 输入邮箱收到的验证码和新密码, **Then** 系统验证码正确性,更新密码,显示成功提示
4. **Given** 用户使用过期的重置链接或验证码, **When** 尝试重置密码, **Then** 系统返回"链接已过期"错误,不允许重置

---

### Edge Cases

- **并发登录**: 同一用户在多个设备或浏览器登录时,如何处理多会话?
  - 默认行为: 允许多会话并存,每个会话独立计时,用户在任一设备登出不影响其他设备
  - 配置选项: 后端可配置最大并发会话数,超过限制时踢出最早的会话

- **网络中断恢复**: 用户在网络断开期间会话过期,恢复网络后的体验?
  - 用户恢复网络后首次API请求将收到401错误,前端自动重定向到登录页并显示"会话已过期,请重新登录"提示

- **Cookie被禁用**: 用户浏览器禁用Cookie时的降级方案?
  - 系统检测Cookie不可用时,在登录页显示警告提示:"请启用Cookie以正常使用本系统"

- **CSRF攻击防护**: 如何防止跨站请求伪造?
  - 后端会话Cookie配置SameSite=Lax或Strict属性,防止跨站携带Cookie
  - 敏感操作(如密码修改)需要额外验证当前密码

- **密码强度不足**: 用户尝试使用弱密码注册或重置密码?
  - 前端实时校验密码强度,显示要求(最小长度、大小写、数字、特殊字符)
  - 后端拒绝不符合要求的密码,返回具体缺失项

- **验证码过期或错误**: 用户使用过期或错误的验证码?
  - 系统返回明确错误提示:"验证码已过期,请重新获取"或"验证码错误"
  - 验证码有尝试次数限制,超过限制后需重新发送

- **频繁请求验证码**: 用户短时间内多次请求验证码?
  - 后端实施速率限制,同一邮箱每60秒只能请求一次验证码
  - 前端显示倒计时,禁用"发送验证码"按钮直到倒计时结束

## Requirements *(mandatory)*

### Functional Requirements

#### 鉴权机制

- **FR-001**: 系统MUST使用基于会话(Session)的Cookie鉴权机制,前端通过HttpOnly Cookie携带会话ID,后端通过Redis验证会话
- **FR-002**: 系统MUST在后端实现完整的会话生命周期管理,包括创建、续期、过期和销毁
- **FR-003**: 后端MUST在每个受保护的API端点验证会话有效性,未认证的请求返回401 HTTP状态码
- **FR-004**: 系统MUST移除所有Mock鉴权逻辑,前端不再自动注入mock token,后端不再识别mock token

#### 登录流程

- **FR-005**: 用户访问应用根路径(/)或任何受保护页面时,未登录用户MUST自动重定向到登录页面(/auth/login)
- **FR-006**: 用户在登录页输入邮箱和密码后,系统MUST验证凭据,成功则创建会话并返回用户信息,失败则返回明确的错误提示
- **FR-007**: 登录成功后,用户MUST自动重定向到主页(/dashboard/homepage)
- **FR-008**: 已登录用户访问登录页时,系统MUST自动重定向到主页
- **FR-009**: 用户MUST能够勾选"记住我"选项,使会话有效期延长至30天(默认会话有效期为24小时)

#### 会话管理

- **FR-010**: 系统MUST在Redis中存储会话数据,包括用户ID、邮箱、姓名、IP地址、User-Agent等信息
- **FR-011**: 会话Cookie MUST配置为HttpOnly、Secure(生产环境)、SameSite=Lax,防止XSS和CSRF攻击
- **FR-012**: 用户点击登出按钮时,系统MUST销毁服务器端会话,清除客户端Cookie,并重定向到登录页
- **FR-013**: 系统MUST支持并发会话,默认每个用户最多10个活跃会话,超过限制时自动销毁最早的会话
- **FR-014**: 会话过期后,用户下次API请求MUST返回401错误,前端MUST自动清除本地状态并重定向到登录页

#### API请求鉴权

- **FR-015**: 前端所有API请求MUST配置credentials: 'include',自动携带会话Cookie
- **FR-016**: 后端MUST通过依赖注入(Dependency Injection)在需要鉴权的端点获取当前用户信息
- **FR-017**: 前端MUST实现全局HTTP拦截器,捕获401响应,自动清除认证状态并重定向到登录页
- **FR-018**: 系统MUST记录所有鉴权失败事件,包括IP地址、User-Agent、失败原因等,用于安全审计

#### 注册流程

- **FR-019**: 用户MUST能够通过邮箱注册账号,系统发送6位数字验证码到用户邮箱
- **FR-020**: 验证码MUST在5分钟内有效,过期后用户需重新请求
- **FR-021**: 系统MUST验证密码强度,要求至少8个字符,包含大小写字母、数字和特殊字符
- **FR-022**: 注册成功后,用户MUST收到欢迎邮件,并被引导到登录页

#### 密码重置流程

- **FR-023**: 用户MUST能够通过邮箱请求密码重置,系统支持两种模式:重置链接(token模式)或验证码(code模式)
- **FR-024**: 重置令牌MUST在1小时内有效,验证码在15分钟内有效
- **FR-025**: 密码重置成功后,系统MUST销毁所有该用户的活跃会话,要求用户重新登录

#### 速率限制

- **FR-026**: 系统MUST对登录请求实施速率限制:同一IP和邮箱组合每5分钟最多尝试5次
- **FR-027**: 系统MUST对验证码请求实施速率限制:同一邮箱每60秒只能请求一次
- **FR-028**: 超过速率限制后,系统MUST返回429 HTTP状态码,并在响应中包含重试时间

### Key Entities

- **User**: 用户实体,包含邮箱、姓名、密码哈希、是否已验证、是否激活、上次登录时间等属性
- **Session**: 会话实体,存储在Redis中,包含会话ID、用户ID、邮箱、姓名、IP地址、User-Agent、创建时间、过期时间等属性
- **UserLoginHistory**: 登录历史记录,包含用户ID、登录时间、IP地址、User-Agent、是否成功、SSO提供商等属性
- **UserPasswordReset**: 密码重置记录,包含用户ID、令牌、验证码、创建时间、过期时间、是否已使用等属性
- **VerificationCode**: 验证码,存储在Redis中,包含邮箱、验证码、创建时间、过期时间等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在10秒内完成登录流程(输入凭据到进入主页)
- **SC-002**: 系统能够支持至少1000个并发登录用户,响应时间不超过500毫秒
- **SC-003**: 所有API请求的鉴权验证时间不超过50毫秒
- **SC-004**: 未登录用户访问受保护页面时,100%的情况下自动重定向到登录页
- **SC-005**: 会话过期或无效时,100%的API请求返回401错误,前端正确重定向到登录页
- **SC-006**: 密码强度验证准确率达到100%,不符合要求的密码全部被拒绝
- **SC-007**: 验证码邮件发送成功率达到95%以上,平均发送延迟不超过3秒
- **SC-008**: 登录成功后,用户在所有后续请求中都能正确携带会话凭证,无需手动干预
- **SC-009**: 系统能够正确处理跨标签页的登出操作,所有标签页在下次请求时都能检测到会话失效
- **SC-010**: 所有鉴权相关的错误都有明确的用户友好提示,用户能够理解错误原因并知道如何解决

## Assumptions *(optional)*

- 后端已有完整的用户模型(User)和鉴权API端点(/auth/login, /auth/logout, /auth/register等)
- 后端使用Redis作为会话存储,已配置好Redis连接
- 后端使用FastAPI框架,支持依赖注入(Dependency Injection)获取当前用户
- 前端使用React Router进行路由管理
- 前端使用Axios或Fetch API进行HTTP请求
- 邮件服务已配置,能够发送验证码和密码重置邮件
- 生产环境使用HTTPS,确保Cookie的Secure属性有效
- 用户浏览器支持Cookie,未禁用Cookie功能

## Dependencies *(optional)*

- **后端依赖**: FastAPI会话中间件已实现,能够从Cookie中提取会话ID并在Redis中查找会话
- **前端依赖**: HTTP客户端(Axios或自定义BaseApiClient)已配置好拦截器功能
- **环境依赖**: Redis服务运行正常,邮件SMTP服务配置正确
- **测试依赖**: 需要测试账号和测试邮箱,用于验证登录、注册、密码重置流程

## Scope *(optional)*

### In Scope

- 移除前端和后端的所有Mock鉴权逻辑
- 前端路由守卫,未登录用户自动重定向到登录页
- 前端HTTP拦截器,处理401错误并重定向
- 登录、登出、注册、密码重置的完整前后端集成
- 会话管理和过期处理
- API请求自动携带会话Cookie
- 验证码发送和验证逻辑
- 速率限制和安全防护(CSRF、XSS)
- 用户友好的错误提示和反馈

### Out of Scope

- SSO(单点登录)集成,如Google OAuth、Azure AD等
- 多因素认证(MFA/2FA)
- API密钥鉴权(Gateway专用,已在Backend/app/gateway/middleware/auth.py中实现)
- 生物识别登录(指纹、人脸识别)
- 自动登录(基于设备指纹)
- 用户权限管理和角色控制(RBAC,已有独立的authz模块)
- 邮箱变更流程
- 账号注销(删除账号)功能

## Notes *(optional)*

### 后端鉴权机制审查结论

经过对后端代码的全面检查,现有鉴权机制具备以下优点:

1. **会话管理完善**: 使用Redis存储会话,支持TTL自动过期,支持"记住我"功能
2. **安全措施到位**:
   - 密码使用bcrypt哈希存储
   - 会话Cookie配置HttpOnly、Secure、SameSite
   - 速率限制防止暴力破解
   - IP封禁机制
3. **完整的认证流程**: 登录、注册、密码重置、邮箱验证等功能齐全
4. **依赖注入模式**: 使用FastAPI的Depends实现CurrentUserDep,代码清晰易维护
5. **审计日志**: 记录登录历史,包括成功和失败的尝试

建议改进:
- 会话ID生成应使用密码学安全的随机数生成器(已使用secrets.token_urlsafe)
- 考虑添加会话刷新(refresh)机制,避免用户在长时间操作中突然退出登录
- 密码重置后强制销毁所有会话,防止旧会话继续有效(需确认是否已实现)

### 前端Mock鉴权移除要点

当前前端Mock鉴权的实现位置:
- `Frontend/src/shared/lib/apiClient.ts:115-121` - Mock token注入逻辑
- `Frontend/src/features/auth/api/authClient.ts` - 根据配置选择Mock或Real实现
- 环境变量 `VITE_USE_MOCK_AUTH` 控制是否启用Mock

移除步骤:
1. 删除apiClient中的Mock token注入逻辑
2. 移除authClient中的MockAuthClient选择分支,始终使用RealAuthClient
3. 删除环境变量VITE_USE_MOCK_AUTH和相关配置
4. 删除MockAuthClient实现文件
5. 更新文档,移除MOCK_AUTH_GUIDE.md或标记为已废弃

### 前端路由改造要点

当前问题:
- `App.tsx` 中根路径(/)和未知路径(*)都重定向到 `/dashboard/homepage`
- 没有登录状态检查,未登录用户也能访问Dashboard

改造方案:
1. 实现ProtectedRoute组件,包裹所有需要鉴权的路由
2. ProtectedRoute检查用户登录状态,未登录则重定向到 `/auth/login`
3. 修改根路径重定向逻辑:未登录重定向到 `/auth/login`,已登录重定向到 `/dashboard/homepage`
4. 登录页检查已登录状态,已登录则自动跳转到主页

### 技术实现建议

**前端状态管理**:
- 使用React Context或Zustand管理用户认证状态
- 存储当前用户信息(从/auth/me获取)
- 提供login、logout、checkAuth等方法

**HTTP拦截器**:
- Response拦截器捕获401状态码
- 清除本地认证状态
- 重定向到登录页,并保存原始URL用于登录后跳转

**会话保活**:
- 用户活跃时定期发送心跳请求(可选)
- 或依赖后端的会话自动续期机制

**用户体验优化**:
- 登录页显示"记住我"选项
- 错误提示清晰友好,区分"邮箱不存在"和"密码错误"(注意安全性,可统一为"邮箱或密码错误")
- 表单验证及时,减少提交失败次数
- 密码重置和注册流程提供进度提示
