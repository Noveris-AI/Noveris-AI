openapi: 3.1.0
info:
  title: Noveris AI - Authentication API
  description: |
    前后端鉴权集成API规范

    本API提供完整的用户认证功能,包括:
    - 用户注册与邮箱验证
    - 登录与登出
    - 密码重置
    - 会话管理

    ## 认证方式

    使用基于会话的Cookie认证:
    - 登录成功后,服务器设置HttpOnly Cookie
    - 前端所有请求自动携带Cookie(需配置credentials: 'include')
    - 会话存储在Redis中,支持TTL自动过期

    ## 安全措施

    - Cookie配置: HttpOnly + Secure + SameSite=Lax
    - 密码: bcrypt哈希存储
    - 速率限制: 防止暴力破解
    - 审计日志: 记录所有登录尝试

  version: 1.0.0
  contact:
    name: Noveris AI Team
    email: support@noveris.ai

servers:
  - url: http://localhost:8000/api/v1
    description: 开发环境
  - url: https://api.noveris.ai/api/v1
    description: 生产环境

tags:
  - name: Authentication
    description: 用户认证相关接口
  - name: User
    description: 用户信息相关接口

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: 用户登录
      description: |
        使用邮箱和密码登录系统

        **成功后行为**:
        - 创建会话并存储到Redis
        - 设置HttpOnly Cookie (session_id)
        - 返回用户信息和重定向URL

        **安全措施**:
        - 速率限制: 同一IP+邮箱 5次/5分钟
        - 失败后IP可能被临时封禁
        - 记录登录历史(成功和失败)

      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              normal:
                summary: 普通登录
                value:
                  email: user@example.com
                  password: SecurePassword123!
                  remember_me: false
              remember:
                summary: 记住我
                value:
                  email: user@example.com
                  password: SecurePassword123!
                  remember_me: true
      responses:
        '200':
          description: 登录成功
          headers:
            Set-Cookie:
              description: 会话Cookie
              schema:
                type: string
                example: session_id=abc123; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=86400
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              examples:
                success:
                  summary: 登录成功
                  value:
                    success: true
                    message: 登录成功
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      name: 张三
                      is_active: true
                      is_verified: true
                      created_at: '2026-01-15T10:00:00Z'
                      last_login_at: '2026-01-16T10:30:00Z'
                    redirect_to: /dashboard/homepage
        '401':
          description: 邮箱或密码错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_credentials:
                  summary: 凭据无效
                  value:
                    success: false
                    detail:
                      code: INVALID_CREDENTIALS
                      message: 邮箱或密码错误
        '429':
          description: 请求过于频繁
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                detail: 登录尝试次数过多,请稍后再试

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: 用户登出
      description: |
        登出当前用户,销毁会话

        **行为**:
        - 从Redis删除会话数据
        - 清除客户端Cookie
        - 记录登出事件(可选)

      operationId: logout
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 登出成功
          headers:
            Set-Cookie:
              description: 清除Cookie
              schema:
                type: string
                example: session_id=; Path=/; Max-Age=0
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                message: 登出成功
        '401':
          description: 未登录
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      tags:
        - Authentication
      summary: 用户注册
      description: |
        注册新用户账号

        **前置条件**:
        - 必须先调用 /auth/send-verification-code 获取验证码

        **成功后行为**:
        - 创建用户账号
        - 标记邮箱已验证
        - 发送欢迎邮件
        - 不自动登录,需用户手动登录

      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              email: newuser@example.com
              verification_code: '123456'
              password: SecurePassword123!
              name: 李四
      responses:
        '200':
          description: 注册成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                message: 注册成功,请登录
        '400':
          description: 验证码错误或密码强度不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_code:
                  summary: 验证码无效
                  value:
                    success: false
                    detail:
                      code: INVALID_CODE
                      message: 验证码错误或已过期
                weak_password:
                  summary: 密码强度不足
                  value:
                    success: false
                    detail:
                      code: WEAK_PASSWORD
                      message: 密码强度不足
                      details: ['至少8个字符', '包含大写字母', '包含数字']
        '409':
          description: 邮箱已注册
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                detail:
                  code: EMAIL_EXISTS
                  message: 该邮箱已注册

  /auth/send-verification-code:
    post:
      tags:
        - Authentication
      summary: 发送验证码
      description: |
        发送邮箱验证码(用于注册)

        **速率限制**:
        - 同一邮箱: 1次/60秒
        - 前端应显示60秒倒计时

        **验证码特性**:
        - 6位数字
        - 有效期5分钟
        - 存储在Redis中

      operationId: sendVerificationCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendVerificationCodeRequest'
            example:
              email: user@example.com
      responses:
        '200':
          description: 验证码已发送
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                message: 验证码已发送到您的邮箱
        '429':
          description: 请求过于频繁
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: 请求密码重置
      description: |
        请求密码重置链接或验证码

        **安全措施**:
        - 始终返回成功,不透露用户是否存在
        - 仅在用户存在时才发送邮件

        **支持两种模式**:
        - Token模式: 发送重置链接(包含token)
        - Code模式: 发送6位验证码
        - 由后端配置决定使用哪种模式

      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
            example:
              email: user@example.com
      responses:
        '200':
          description: 请求已处理(始终返回成功)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                message: 如果账号存在,重置链接已发送到您的邮箱

  /auth/reset-password:
    post:
      tags:
        - Authentication
      summary: 重置密码
      description: |
        使用令牌或验证码重置密码

        **输入要求**:
        - 必须提供token或code之一
        - 新密码必须符合强度要求

        **成功后行为**:
        - 更新密码哈希
        - 销毁所有活跃会话(要求重新登录)
        - 标记重置记录为已使用

      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            examples:
              with_token:
                summary: 使用令牌
                value:
                  token: abc123def456...
                  new_password: NewSecurePassword123!
              with_code:
                summary: 使用验证码
                value:
                  code: '123456'
                  new_password: NewSecurePassword123!
      responses:
        '200':
          description: 密码重置成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                message: 密码重置成功,请重新登录
        '400':
          description: 令牌无效或密码强度不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/change-password:
    post:
      tags:
        - Authentication
      summary: 修改密码
      description: |
        已登录用户修改密码

        **安全要求**:
        - 必须提供当前密码进行验证
        - 新密码必须符合强度要求

        **成功后行为**:
        - 更新密码哈希
        - 不销毁当前会话(用户继续保持登录)
        - 其他设备的会话仍然有效

      operationId: changePassword
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
            example:
              current_password: OldPassword123!
              new_password: NewSecurePassword123!
      responses:
        '200':
          description: 密码修改成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: 当前密码错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未登录
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - User
      summary: 获取当前用户信息
      description: |
        获取当前登录用户的详细信息

        **用途**:
        - 前端初始化时获取用户信息
        - 验证会话是否有效
        - 刷新用户数据

      operationId: getCurrentUser
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 用户信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
              example:
                id: 550e8400-e29b-41d4-a716-446655440000
                email: user@example.com
                name: 张三
                is_active: true
                is_verified: true
                created_at: '2026-01-15T10:00:00Z'
                last_login_at: '2026-01-16T10:30:00Z'
        '401':
          description: 未登录或会话已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/sessions:
    get:
      tags:
        - User
      summary: 查看活跃会话
      description: |
        查看当前用户的所有活跃会话

        **返回信息**:
        - 活跃会话数量
        - 最大允许会话数

      operationId: listSessions
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 会话列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      active_sessions:
                        type: integer
                        description: 当前活跃会话数
                      max_sessions:
                        type: integer
                        description: 最大允许会话数
              example:
                success: true
                data:
                  active_sessions: 3
                  max_sessions: 10
    delete:
      tags:
        - User
      summary: 撤销所有会话
      description: |
        撤销当前用户的所有会话(除当前会话外)

        **行为**:
        - 销毁Redis中的所有其他会话
        - 为当前请求创建新会话
        - 更新客户端Cookie

        **用途**:
        - 安全场景:怀疑账号被盗,一键登出所有设备

      operationId: revokeAllSessions
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 所有会话已撤销
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: session_id
      description: 基于Cookie的会话认证

  schemas:
    # ========================================
    # Request Schemas
    # ========================================

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: 用户邮箱
          example: user@example.com
        password:
          type: string
          minLength: 1
          maxLength: 255
          description: 用户密码
          example: SecurePassword123!
        remember_me:
          type: boolean
          default: false
          description: 是否记住登录状态(30天)

    RegisterRequest:
      type: object
      required:
        - email
        - verification_code
        - password
      properties:
        email:
          type: string
          format: email
          description: 用户邮箱
        verification_code:
          type: string
          minLength: 4
          maxLength: 10
          description: 邮箱验证码(6位数字)
          example: '123456'
        password:
          type: string
          minLength: 8
          maxLength: 128
          description: 密码(需符合强度要求)
        name:
          type: string
          maxLength: 100
          description: 显示名称(可选,默认使用邮箱)

    SendVerificationCodeRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: 接收验证码的邮箱

    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: 注册邮箱

    ResetPasswordRequest:
      type: object
      required:
        - new_password
      properties:
        token:
          type: string
          description: 重置令牌(从邮件链接获取)
        code:
          type: string
          description: 验证码(手动输入)
          example: '123456'
        new_password:
          type: string
          minLength: 8
          maxLength: 128
          description: 新密码(需符合强度要求)

    ChangePasswordRequest:
      type: object
      required:
        - current_password
        - new_password
      properties:
        current_password:
          type: string
          minLength: 1
          maxLength: 255
          description: 当前密码
        new_password:
          type: string
          minLength: 8
          maxLength: 128
          description: 新密码(需符合强度要求)

    # ========================================
    # Response Schemas
    # ========================================

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 用户ID
        email:
          type: string
          format: email
          description: 用户邮箱
        name:
          type: string
          description: 显示名称
        is_active:
          type: boolean
          description: 账号是否激活
        is_verified:
          type: boolean
          description: 邮箱是否已验证
        created_at:
          type: string
          format: date-time
          nullable: true
          description: 创建时间(ISO8601)
        last_login_at:
          type: string
          format: date-time
          nullable: true
          description: 最后登录时间(ISO8601)

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
        message:
          type: string
          nullable: true
          description: 提示信息
        user:
          $ref: '#/components/schemas/UserResponse'
          nullable: true
        redirect_to:
          type: string
          nullable: true
          description: 登录后重定向URL

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
        message:
          type: string
          nullable: true
          description: 提示信息
        data:
          type: object
          nullable: true
          description: 额外数据

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          default: false
        detail:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/ErrorDetail'
          description: 错误详情

    ErrorDetail:
      type: object
      properties:
        code:
          type: string
          description: 错误代码
          example: INVALID_CREDENTIALS
        message:
          type: string
          description: 错误消息
        details:
          type: array
          items:
            type: string
          nullable: true
          description: 详细错误列表

  # ========================================
  # Error Codes
  # ========================================

  # 常见错误代码:
  # - INVALID_CREDENTIALS: 邮箱或密码错误
  # - INVALID_CODE: 验证码错误或已过期
  # - WEAK_PASSWORD: 密码强度不足
  # - EMAIL_EXISTS: 邮箱已注册
  # - INVALID_TOKEN: 重置令牌无效或已过期
  # - INVALID_PASSWORD: 当前密码错误
  # - RESET_FAILED: 密码重置失败
