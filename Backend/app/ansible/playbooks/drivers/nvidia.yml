---
# NVIDIA Driver Installation Playbook
# Installs NVIDIA drivers, CUDA toolkit, and related components
#
# Variables:
#   nvidia_driver_version: Target driver version (e.g., "535")
#   cuda_version: CUDA toolkit version (e.g., "12.2")
#   install_fabricmanager: Enable nvidia-fabricmanager for NVSwitch nodes
#   enable_persistence_mode: Enable nvidia-persistenced
#   disable_nouveau: Blacklist nouveau driver
#   reboot_if_required: Allow reboot after driver installation
#   serial: Rolling update batch size (e.g., "10%", "3")

- name: Install NVIDIA GPU Stack
  hosts: all
  gather_facts: true
  become: true
  serial: "{{ serial | default(omit) }}"
  vars:
    nvidia_driver_version: "535"
    cuda_version: "12.2"
    install_fabricmanager: false
    enable_persistence_mode: true
    disable_nouveau: true
    reboot_if_required: false

  tasks:
    # ==========================================================================
    # Pre-flight Checks
    # ==========================================================================
    - name: Check for NVIDIA GPU
      ansible.builtin.command: lspci -nn | grep -i nvidia
      register: nvidia_pci_check
      failed_when: false
      changed_when: false

    - name: Fail if no NVIDIA GPU found
      ansible.builtin.fail:
        msg: "No NVIDIA GPU detected on this node"
      when: nvidia_pci_check.rc != 0

    - name: Check if driver already installed
      ansible.builtin.command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
      register: current_driver
      failed_when: false
      changed_when: false

    - name: Set driver_installed fact
      ansible.builtin.set_fact:
        driver_installed: "{{ current_driver.rc == 0 }}"
        current_version: "{{ current_driver.stdout | trim | split('.') | first | default('0') }}"

    # ==========================================================================
    # Nouveau Blacklist
    # ==========================================================================
    - name: Blacklist nouveau driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        content: |
          blacklist nouveau
          options nouveau modeset=0
        mode: '0644'
      when: disable_nouveau
      register: nouveau_blacklist

    - name: Update initramfs (Debian/Ubuntu)
      ansible.builtin.command: update-initramfs -u
      when:
        - nouveau_blacklist.changed
        - ansible_os_family == "Debian"

    - name: Update initramfs (RHEL/CentOS)
      ansible.builtin.command: dracut --force
      when:
        - nouveau_blacklist.changed
        - ansible_os_family == "RedHat"

    # ==========================================================================
    # Repository Setup
    # ==========================================================================
    - name: Add NVIDIA CUDA repository (Ubuntu)
      ansible.builtin.apt_key:
        url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu{{ ansible_distribution_version | replace('.', '') }}/x86_64/3bf863cc.pub
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Add NVIDIA CUDA apt repository (Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu{{ ansible_distribution_version | replace('.', '') }}/x86_64/ /"
        state: present
        filename: cuda
      when: ansible_distribution == "Ubuntu"

    - name: Add NVIDIA CUDA repository (RHEL/CentOS)
      ansible.builtin.yum_repository:
        name: cuda
        description: NVIDIA CUDA Repository
        baseurl: "https://developer.download.nvidia.com/compute/cuda/repos/rhel{{ ansible_distribution_major_version }}/x86_64/"
        gpgkey: "https://developer.download.nvidia.com/compute/cuda/repos/rhel{{ ansible_distribution_major_version }}/x86_64/D42D0685.pub"
        gpgcheck: true
        enabled: true
      when: ansible_os_family == "RedHat"

    # ==========================================================================
    # Driver Installation
    # ==========================================================================
    - name: Install NVIDIA driver and CUDA (Ubuntu)
      ansible.builtin.apt:
        name:
          - "cuda-drivers-{{ nvidia_driver_version }}"
          - "cuda-toolkit-{{ cuda_version | replace('.', '-') }}"
        state: present
        update_cache: true
      when: ansible_distribution == "Ubuntu"
      register: nvidia_install_ubuntu

    - name: Install NVIDIA driver and CUDA (RHEL/CentOS)
      ansible.builtin.yum:
        name:
          - "nvidia-driver-{{ nvidia_driver_version }}"
          - "cuda-{{ cuda_version | replace('.', '-') }}"
        state: present
      when: ansible_os_family == "RedHat"
      register: nvidia_install_rhel

    - name: Set installation result
      ansible.builtin.set_fact:
        nvidia_installed: "{{ nvidia_install_ubuntu.changed | default(false) or nvidia_install_rhel.changed | default(false) }}"

    # ==========================================================================
    # Fabric Manager (for NVSwitch nodes)
    # ==========================================================================
    - name: Install nvidia-fabricmanager
      ansible.builtin.package:
        name: nvidia-fabricmanager
        state: present
      when: install_fabricmanager

    - name: Enable and start nvidia-fabricmanager
      ansible.builtin.systemd:
        name: nvidia-fabricmanager
        enabled: true
        state: started
      when: install_fabricmanager

    # ==========================================================================
    # Persistence Mode
    # ==========================================================================
    - name: Install nvidia-persistenced
      ansible.builtin.package:
        name: nvidia-persistenced
        state: present
      when: enable_persistence_mode

    - name: Enable and start nvidia-persistenced
      ansible.builtin.systemd:
        name: nvidia-persistenced
        enabled: true
        state: started
      when: enable_persistence_mode

    # ==========================================================================
    # Verification
    # ==========================================================================
    - name: Verify NVIDIA driver (if no reboot needed)
      ansible.builtin.command: nvidia-smi
      register: nvidia_verify
      failed_when: false
      changed_when: false
      when: not nvidia_installed

    # ==========================================================================
    # Reboot Handling
    # ==========================================================================
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      when: ansible_os_family == "Debian"

    - name: Set reboot_needed fact
      ansible.builtin.set_fact:
        reboot_needed: "{{ nvidia_installed or nouveau_blacklist.changed or (reboot_required_file.stat.exists | default(false)) }}"

    - name: Reboot node if required
      ansible.builtin.reboot:
        msg: "Rebooting for NVIDIA driver installation"
        reboot_timeout: 600
        post_reboot_delay: 30
      when:
        - reboot_if_required
        - reboot_needed

    - name: Wait for nvidia-smi after reboot
      ansible.builtin.command: nvidia-smi
      register: post_reboot_check
      retries: 5
      delay: 10
      until: post_reboot_check.rc == 0
      when:
        - reboot_if_required
        - reboot_needed

    # ==========================================================================
    # Final Status
    # ==========================================================================
    - name: Get final driver status
      ansible.builtin.command: nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader
      register: final_status
      failed_when: false
      changed_when: false

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "NVIDIA Driver Installation Complete"
          - "Driver version: {{ nvidia_driver_version }}"
          - "CUDA version: {{ cuda_version }}"
          - "Fabric Manager: {{ 'Enabled' if install_fabricmanager else 'Disabled' }}"
          - "Persistence Mode: {{ 'Enabled' if enable_persistence_mode else 'Disabled' }}"
          - "Reboot performed: {{ reboot_needed | default(false) }}"
          - "GPU Status: {{ final_status.stdout | default('Pending reboot') }}"

    - name: Create installation status file
      ansible.builtin.copy:
        content: |
          nvidia_driver_version: "{{ nvidia_driver_version }}"
          cuda_version: "{{ cuda_version }}"
          installed_at: "{{ ansible_date_time.iso8601 }}"
          reboot_performed: {{ reboot_needed | default(false) }}
          fabricmanager_enabled: {{ install_fabricmanager }}
          persistence_enabled: {{ enable_persistence_mode }}
        dest: /tmp/noveris_facts/nvidia_install_status.yml
        mode: '0644'
