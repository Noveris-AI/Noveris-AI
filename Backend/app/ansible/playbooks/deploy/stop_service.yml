---
# stop_service.yml
#
# Stop the model serving service.

- name: Stop model serving service
  hosts: all
  become: true
  gather_facts: false

  vars:
    service_name: "noveris-model-{{ deployment_id[:12] }}"

  tasks:
    - name: Stop the service
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        state: stopped
      register: stop_result
      failed_when: false

    - name: Check if service stopped successfully
      ansible.builtin.debug:
        msg: "Service {{ service_name }} stopped: {{ stop_result.changed }}"

    - name: Wait for port to be released
      ansible.builtin.wait_for:
        port: "{{ port }}"
        host: "127.0.0.1"
        state: stopped
        timeout: 30
      failed_when: false
