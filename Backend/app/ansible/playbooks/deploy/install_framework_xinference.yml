---
# install_framework_xinference.yml
#
# Install Xinference in a dedicated virtual environment.
#
# Reference: https://inference.readthedocs.io/en/latest/getting_started/installation.html

- name: Install Xinference framework
  hosts: all
  become: true
  gather_facts: true

  vars:
    venv_base: "{{ venv_base | default('/opt/model-runtimes') }}"
    deploy_user: "{{ deploy_user | default('modelserve') }}"
    deploy_group: "{{ deploy_group | default('modelserve') }}"
    install_profile: "{{ install_profile | default('nvidia_cuda') }}"
    python_version: "{{ python_version | default('python3.11') }}"

  tasks:
    - name: Ensure venv base directory exists
      ansible.builtin.file:
        path: "{{ venv_base }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0755"

    - name: Create Xinference virtual environment
      ansible.builtin.command:
        cmd: "{{ python_version }} -m venv {{ venv_base }}/xinference-{{ deployment_id }}"
        creates: "{{ venv_base }}/xinference-{{ deployment_id }}/bin/activate"
      become_user: "{{ deploy_user }}"

    - name: Upgrade pip in venv
      ansible.builtin.pip:
        name: pip
        state: latest
        virtualenv: "{{ venv_base }}/xinference-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"

    - name: Install Xinference with all backends
      ansible.builtin.pip:
        name:
          - xinference[all]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/xinference-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "nvidia_cuda"

    - name: Install Xinference for CPU (with llama.cpp)
      ansible.builtin.pip:
        name:
          - xinference[llama_cpp]
          - xllamacpp
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/xinference-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "cpu_only"

    - name: Install Xinference for Apple Silicon
      ansible.builtin.pip:
        name:
          - xinference[mlx]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/xinference-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "apple_mlx"

    - name: Verify Xinference installation
      ansible.builtin.command:
        cmd: "{{ venv_base }}/xinference-{{ deployment_id }}/bin/python -c 'import xinference; print(xinference.__version__)'"
      register: xinference_version
      changed_when: false

    - name: Display Xinference version
      ansible.builtin.debug:
        msg: "Installed Xinference version: {{ xinference_version.stdout }}"

    - name: Set venv path fact
      ansible.builtin.set_fact:
        framework_venv_path: "{{ venv_base }}/xinference-{{ deployment_id }}"
