---
# install_framework_sglang.yml
#
# Install SGLang in a dedicated virtual environment.
#
# Reference: https://docs.sglang.io/get_started/install.html

- name: Install SGLang framework
  hosts: all
  become: true
  gather_facts: true

  vars:
    venv_base: "{{ venv_base | default('/opt/model-runtimes') }}"
    deploy_user: "{{ deploy_user | default('modelserve') }}"
    deploy_group: "{{ deploy_group | default('modelserve') }}"
    install_profile: "{{ install_profile | default('nvidia_cuda') }}"
    python_version: "{{ python_version | default('python3.11') }}"

  tasks:
    - name: Ensure venv base directory exists
      ansible.builtin.file:
        path: "{{ venv_base }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0755"

    - name: Create SGLang virtual environment
      ansible.builtin.command:
        cmd: "{{ python_version }} -m venv {{ venv_base }}/sglang-{{ deployment_id }}"
        creates: "{{ venv_base }}/sglang-{{ deployment_id }}/bin/activate"
      become_user: "{{ deploy_user }}"

    - name: Upgrade pip in venv
      ansible.builtin.pip:
        name:
          - pip
          - uv
        state: latest
        virtualenv: "{{ venv_base }}/sglang-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"

    - name: Install SGLang for NVIDIA CUDA
      ansible.builtin.pip:
        name:
          - sglang[all]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/sglang-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "nvidia_cuda"

    - name: Install SGLang for CPU
      ansible.builtin.pip:
        name:
          - sglang[srt_cpu]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/sglang-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "cpu_only"

    - name: Install SGLang for AMD ROCm
      ansible.builtin.pip:
        name:
          - sglang[all_hip]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/sglang-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "amd_rocm"

    - name: Install SGLang for Ascend NPU
      ansible.builtin.pip:
        name:
          - sglang[srt_npu]
          - huggingface_hub
        state: present
        virtualenv: "{{ venv_base }}/sglang-{{ deployment_id }}"
      become_user: "{{ deploy_user }}"
      when: install_profile == "ascend_cann"

    - name: Verify SGLang installation
      ansible.builtin.command:
        cmd: "{{ venv_base }}/sglang-{{ deployment_id }}/bin/python -c 'import sglang; print(sglang.__version__)'"
      register: sglang_version
      changed_when: false

    - name: Display SGLang version
      ansible.builtin.debug:
        msg: "Installed SGLang version: {{ sglang_version.stdout }}"

    - name: Set venv path fact
      ansible.builtin.set_fact:
        framework_venv_path: "{{ venv_base }}/sglang-{{ deployment_id }}"
